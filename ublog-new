#!/bin/bash

TDAY=$(date +%F)
CURRENT_TIME=$(date +"%I:%M:%S%p")  # Use - instead of : to avoid issues in filenames
NEW_POST="ublog/$TDAY-$CURRENT_TIME.md"

# Initialize variables
HEADING=""
CONTENT=""
GIT_PUSH=false

# Help text
usage() {
  echo "Usage: $0 [-h heading] [-m markdown] [-g]"
  echo "  -h heading     : Specify post heading (optional)"
  echo "  -m markdown    : Specify post content (optional)"
  echo "  -g             : Push to git after generating post (optional)"
  exit 1
}

# Parse flags
while getopts ":h:m:g" opt; do
  case $opt in
    h) HEADING="$OPTARG" ;;
    m) CONTENT="$OPTARG" ;;
    g) GIT_PUSH=true ;;
    \?) echo "Invalid option: -$OPTARG" >&2; usage ;;
    :) echo "Option -$OPTARG requires an argument." >&2; usage ;;
  esac
done

# Create post file
if [ -n "$HEADING" ] || [ -n "$CONTENT" ]; then
  {
    if [ -n "$HEADING" ]; then
      echo "# $HEADING"
    fi
    echo
    if [ -n "$CONTENT" ]; then
      echo "$CONTENT"
    fi
  } > "$NEW_POST"
else
  nvim "$NEW_POST"
fi

# Run post generation
if [ -e "$NEW_POST" ]; then
  ./ublog-generate.sh

  if [ "$GIT_PUSH" = true ]; then
    git add "$NEW_POST"
    git commit -m "Post: $TDAY $CURRENT_TIME"
    git push
  fi
fi
